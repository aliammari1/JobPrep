import { NextRequest, NextResponse } from "next/server";

// Simple fallback: Returns mock/demo data for LinkedIn import
// User will manually edit the imported data in the CV builder

interface LinkedInData {
	personalInfo: {
		fullName: string;
		title: string;
		email: string;
		phone: string;
		location: string;
		summary: string;
		linkedin: string;
		photo: string;
	};
	experience: Array<{
		id: string;
		title: string;
		company: string;
		location: string;
		startDate: string;
		endDate: string;
		current: boolean;
		description: string;
		highlights: string[];
	}>;
	education: Array<{
		id: string;
		degree: string;
		institution: string;
		location: string;
		startDate: string;
		endDate: string;
		gpa: string;
		description: string;
	}>;
	skills: Array<{
		id: string;
		category: string;
		items: string[];
		level: string;
	}>;
	languages: string[];
	certifications: Array<{
		id: string;
		name: string;
		issuer: string;
		date: string;
		url: string;
	}>;
	projects: Array<{
		id: string;
		name: string;
		description: string;
		technologies: string[];
		url: string;
	}>;
	awards: Array<{
		id: string;
		title: string;
		issuer: string;
		date: string;
		description: string;
	}>;
}

export async function POST(request: NextRequest) {
	try {
		const { username } = await request.json();

		if (!username) {
			return NextResponse.json(
				{ error: "Username is required" },
				{ status: 400 }
			);
		}

		// Clean username (remove any URLs or special characters)
		const cleanUsername = username
			.replace(/.*linkedin\.com\/in\//, "")
			.replace(/\/$/, "")
			.trim();

		const profileUrl = `https://www.linkedin.com/in/${cleanUsername}`;

		// Launch Puppeteer with stealth mode
		const browser = await puppeteer.launch({
			headless: true,
			args: [
				"--no-sandbox",
				"--disable-setuid-sandbox",
				"--disable-dev-shm-usage",
				"--disable-accelerated-2d-canvas",
				"--disable-gpu",
			],
		});

		const page = await browser.newPage();

		// Set user agent to avoid detection
		await page.setUserAgent(
			"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
		);

		// Set viewport
		await page.setViewport({ width: 1920, height: 1080 });

		try {
			// Navigate to LinkedIn profile
			await page.goto(profileUrl, { waitUntil: "networkidle2", timeout: 30000 });

			// Wait for profile content to load
			await page.waitForSelector("body", { timeout: 10000 });

			// Get page content
			const content = await page.content();
			const $ = cheerio.load(content);

			// Extract profile data
			const scrapedData: LinkedInData = {
				personalInfo: {
					fullName: "",
					title: "",
					email: "",
					phone: "",
					location: "",
					summary: "",
					linkedin: profileUrl,
					photo: "",
				},
				experience: [],
				education: [],
				skills: [],
				languages: [],
				certifications: [],
				projects: [],
				awards: [],
			};

			// Extract name
			const nameSelectors = [
				"h1.text-heading-xlarge",
				"h1.top-card-layout__title",
				".pv-text-details__left-panel h1",
				'[data-generated-suggestion-target="profile-name"]',
			];
			for (const selector of nameSelectors) {
				const name = $(selector).first().text().trim();
				if (name) {
					scrapedData.personalInfo.fullName = name;
					break;
				}
			}

			// Extract title/headline
			const titleSelectors = [
				".text-body-medium.break-words",
				".top-card-layout__headline",
				".pv-text-details__left-panel .text-body-medium",
			];
			for (const selector of titleSelectors) {
				const title = $(selector).first().text().trim();
				if (title && title !== scrapedData.personalInfo.fullName) {
					scrapedData.personalInfo.title = title;
					break;
				}
			}

			// Extract location
			const locationSelectors = [
				".text-body-small.inline.t-black--light.break-words",
				".top-card-layout__location",
				".pv-text-details__left-panel .text-body-small",
			];
			for (const selector of locationSelectors) {
				const location = $(selector).first().text().trim();
				if (location) {
					scrapedData.personalInfo.location = location;
					break;
				}
			}

			// Extract profile photo
			const photoSelectors = ["img.pv-top-card-profile-picture__image", "img[data-test-profile-image]"];
			for (const selector of photoSelectors) {
				const photo = $(selector).attr("src");
				if (photo) {
					scrapedData.personalInfo.photo = photo;
					break;
				}
			}

			// Extract about/summary
			const aboutSelectors = [
				".pv-about__summary-text",
				'[data-generated-suggestion-target="profile-about"] .inline-show-more-text',
				".core-section-container__content .inline-show-more-text",
			];
			for (const selector of aboutSelectors) {
				const summary = $(selector).first().text().trim();
				if (summary) {
					scrapedData.personalInfo.summary = summary;
					break;
				}
			}

			// Extract experience
			const experienceSection = $('section[data-section="experience"], #experience-section').first();
			experienceSection.find("li").each((i, elem) => {
				const $elem = $(elem);
				const title = $elem.find(".mr1.t-bold span").first().text().trim();
				const company = $elem.find(".t-14.t-normal span").first().text().trim();
				const dates = $elem.find(".t-14.t-normal.t-black--light span").first().text().trim();
				const location = $elem.find(".t-14.t-normal.t-black--light span").eq(1).text().trim();
				const description = $elem.find(".inline-show-more-text").text().trim();

				if (title && company) {
					const [startDate, endDate] = parseDates(dates);
					scrapedData.experience.push({
						id: Date.now().toString() + i,
						title,
						company: company.split("Â·")[0].trim(),
						location,
						startDate,
						endDate,
						current: dates.toLowerCase().includes("present"),
						description,
						highlights: description ? [description] : [],
					});
				}
			});

			// Extract education
			const educationSection = $('section[data-section="education"], #education-section').first();
			educationSection.find("li").each((i, elem) => {
				const $elem = $(elem);
				const institution = $elem.find(".mr1.t-bold span").first().text().trim();
				const degree = $elem.find(".t-14.t-normal span").first().text().trim();
				const dates = $elem.find(".t-14.t-normal.t-black--light span").first().text().trim();

				if (institution) {
					const [startDate, endDate] = parseDates(dates);
					scrapedData.education.push({
						id: Date.now().toString() + i,
						degree: degree || "Degree",
						institution,
						location: "",
						startDate,
						endDate,
						gpa: "",
						description: "",
					});
				}
			});

			// Extract skills
			const skillsSection = $('section[data-section="skills"], #skills-section').first();
			const skillsArray: string[] = [];
			skillsSection.find(".mr1.t-bold span, .hoverable-link-text").each((i, elem) => {
				const skill = $(elem).text().trim();
				if (skill && !skillsArray.includes(skill)) {
					skillsArray.push(skill);
				}
			});

			if (skillsArray.length > 0) {
				scrapedData.skills.push({
					id: Date.now().toString(),
					category: "Skills",
					items: skillsArray,
					level: "intermediate",
				});
			}

			// Extract certifications
			const certsSection = $('section[data-section="certifications"], #certifications-section').first();
			certsSection.find("li").each((i, elem) => {
				const $elem = $(elem);
				const name = $elem.find(".mr1.t-bold span").first().text().trim();
				const issuer = $elem.find(".t-14.t-normal span").first().text().trim();
				const date = $elem.find(".t-14.t-normal.t-black--light span").first().text().trim();

				if (name) {
					scrapedData.certifications.push({
						id: Date.now().toString() + i,
						name,
						issuer,
						date: date || "",
						url: "",
					});
				}
			});

			await browser.close();

			// Validate that we got some data
			if (!scrapedData.personalInfo.fullName) {
				throw new Error("Could not extract profile data. Profile may be private or username is incorrect.");
			}

			return NextResponse.json({
				success: true,
				data: scrapedData,
				message: `Successfully scraped LinkedIn profile: ${cleanUsername}`,
			});
		} catch (pageError) {
			await browser.close();
			throw pageError;
		}
	} catch (error: any) {
		console.error("LinkedIn scraping error:", error);
		return NextResponse.json(
			{
				error: "Failed to scrape LinkedIn profile",
				details: error.message || "Unknown error",
				hint: "Make sure the username is correct and the profile is public",
			},
			{ status: 500 }
		);
	}
}

function parseDates(dateString: string): [string, string] {
	const months: { [key: string]: string } = {
		jan: "01", feb: "02", mar: "03", apr: "04", may: "05", jun: "06",
		jul: "07", aug: "08", sep: "09", oct: "10", nov: "11", dec: "12",
	};

	let startDate = "";
	let endDate = "";

	if (dateString) {
		const parts = dateString.toLowerCase().split("-").map((p) => p.trim());
		
		if (parts.length >= 1) {
			const startParts = parts[0].split(" ");
			if (startParts.length >= 2) {
				const month = months[startParts[0].substring(0, 3)] || "01";
				const year = startParts[1];
				startDate = `${year}-${month}`;
			}
		}

		if (parts.length >= 2 && !parts[1].includes("present")) {
			const endParts = parts[1].split(" ");
			if (endParts.length >= 2) {
				const month = months[endParts[0].substring(0, 3)] || "12";
				const year = endParts[1];
				endDate = `${year}-${month}`;
			}
		}
	}

	return [startDate, endDate];
}
